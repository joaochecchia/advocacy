<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cliente - Teste STOMP WebSocket</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #messages {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            background: #f5f5f5;
            margin-bottom: 20px;
        }

        input, button {
            padding: 10px;
            font-size: 16px;
        }

        #msg {
            width: 400px;
        }
    </style>
</head>
<body>

<h2>Cliente - Chat</h2>

<div id="messages"></div>

<input type="text" id="msg" placeholder="Mensagem">

<label style="margin-left: 10px;">
    <input type="checkbox" id="usarGpt">
    Perguntar ao ChatGPT
</label>

<button onclick="sendMessage()">Enviar</button>

<br><br>

<button onclick="connect()">Conectar</button>
<button onclick="disconnect()">Desconectar</button>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    let stompClient = null;
    let userId = null;
    let chatId = null;

    const API_BASE = "http://localhost:8080";

    function parseJwt(token) {
        return JSON.parse(atob(token.split('.')[1]));
    }

    function showMessage(msg) {
        const div = document.getElementById("messages");
        div.innerHTML += msg + "<br>";
        div.scrollTop = div.scrollHeight;
    }

    // üîπ BUSCA CLIENTE ANTES DO WEBSOCKET
    async function carregarCliente(token) {
        const jwt = parseJwt(token);
        userId = jwt.usuarioId;

        const response = await fetch(
            `${API_BASE}/cliente/getClienteByUserId/${userId}`,
            {
                headers: {
                    "Authorization": "Bearer " + token
                }
            }
        );

        if (!response.ok) {
            throw new Error("Erro ao buscar cliente");
        }

        const data = await response.json();

        if (!data.Body.chatIds || data.Body.chatIds.length === 0) {
            throw new Error("Cliente n√£o possui chats");
        }

        chatId = data.Body.chatIds[0];

        showMessage("‚úÖ Cliente carregado | Chat ID: " + chatId);
    }

    // üîπ CONECTA NO WEBSOCKET AP√ìS BUSCAR O CLIENTE
    async function connect() {
        const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJub3ZvZW1haWwyM0BnbWFpbC5jb20iLCJ1c3VhcmlvSWQiOjEzLCJub21lVXN1YXJpbyI6Ik5PVk9VU1VBUklPMjMiLCJ0aXBvVXN1YXJpbyI6IkNMSUVOVEUiLCJleHAiOjE3NjYxNjEyMDgsImlhdCI6MTc2NjA3NDgwOCwiaXNzIjoiQVBJIGFkdm9jYWN5Q2hhdCJ9.YRWyL1hHXzXJEij70H4fNKM4aanu5v_9dpiHovo42ZI";

        try {
            await carregarCliente(token);

            const socket = new SockJS(
                `${API_BASE}/build-chat?token=${token}`
            );

            stompClient = Stomp.over(socket);

            stompClient.connect({}, function(frame) {

                stompClient.subscribe(`/topics/chat/${chatId}`, function(msg) {
                    const body = JSON.parse(msg.body);
                    showMessage(body.message);
                });

                showMessage("üü¢ Conectado no chat " + chatId);

            }, function(error) {
                showMessage("‚ùå Erro no websocket: " + error);
            });

        } catch (e) {
            showMessage("‚ùå " + e.message);
        }
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
            showMessage("üî¥ Desconectado");
        }
    }

    // üîπ ENVIA MESSAGE REQUEST (COMPAT√çVEL COM BACKEND)
    function sendMessage() {
        if (!stompClient || !chatId) {
            alert("Conecte-se primeiro!");
            return;
        }

        const mensagem = document.getElementById("msg").value;
        const usarGpt = document.getElementById("usarGpt").checked;

        if (!mensagem) {
            alert("Digite uma mensagem!");
            return;
        }

        stompClient.send(
            `/advocacy-chat/new-message/${chatId}`,
            {},
            JSON.stringify({
                message: mensagem,
                chatId: chatId,
                gpt: usarGpt
            })
        );


        document.getElementById("msg").value = "";
    }
</script>

</body>
</html>
