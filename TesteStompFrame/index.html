<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Teste STOMP WebSocket</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #messages {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            background: #f5f5f5;
            margin-bottom: 20px;
        }

        input, button {
            padding: 10px;
            font-size: 16px;
        }

        #nome {
            width: 200px;
        }

        #msg {
            width: 400px;
        }
    </style>
</head>
<body>

<h2>Teste WebSocket com STOMP + Spring</h2>

<div id="messages"></div>

<input type="text" id="nome" placeholder="Seu nome">
<input type="text" id="msg" placeholder="Mensagem">
<button onclick="sendMessage()">Enviar</button>

<br><br>
<button onclick="connect()">Conectar</button>
<button onclick="disconnect()">Desconectar</button>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    let stompClient = null;

    function connect() {

        // TOKEN JWT (pode pegar do localStorage se quiser)
        const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJtYXJpYS5zaWx2YUBleGFtcGxlLmNvbSIsInVzdWFyaW9JZCI6MSwibm9tZVVzdWFyaW8iOiJNYXJpYSBkYSBTaWx2YSIsImV4cCI6MTc2NTAzMTE0OSwiaWF0IjoxNzY0OTQ0NzQ5LCJpc3MiOiJBUEkgYWR2b2NhY3lDaGF0In0.bIEHb7PzS_zAQOo-qX6xpG3hyNdXJaLisS3puR54oUg";

        // Agora o token via QUERY PARAM (m√©todo recomendado)
        const socket = new SockJS("http://localhost:8080/build-chat?token=" + token);
        stompClient = Stomp.over(socket);

        stompClient.connect(
            {}, // sem headers
            function(frame) {
                console.log("Conectado: " + frame);

                // Se inscreve no t√≥pico
                stompClient.subscribe("/topics/livechat", function(msg) {
                    showMessage(JSON.parse(msg.body).message);
                });

                showMessage("üü¢ Conectado ao servidor WebSocket...");
            },
            function(error) {
                console.log("Erro ao conectar:", error);
                showMessage("‚ùå Erro ao conectar: " + error);
            }
        );
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
            showMessage("üî¥ Desconectado");
        }
    }

    function sendMessage() {
        const nome = document.getElementById("nome").value;
        const mensagem = document.getElementById("msg").value;

        if (!nome || !mensagem) {
            alert("Preencha nome e mensagem!");
            return;
        }

        stompClient.send(
            "/advocacy-chat/new-message",
            {},
            JSON.stringify({
                nomeRemetente: nome,
                message: mensagem
            })
        );
    }

    function showMessage(msg) {
        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML += msg + "<br>";
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>

</body>
</html>
